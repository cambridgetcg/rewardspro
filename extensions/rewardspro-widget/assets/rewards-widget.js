// RewardsPro Widget - Minified with Customer Detection Fix
!function(){'use strict';
class W{constructor(e,t){this.id=e,this.s=t,this.c=document.getElementById(`rewardspro-widget-${e}`),this.w=this.c.querySelector('.rewardspro-widget'),this.m=this.c.querySelector('.rewardspro-minimized'),this.min=t.startMinimized,this.d=null,this.init()}
init(){this.c&&(this.applyTheme(),this.c.setAttribute('data-position',this.s.position),'loading'===document.readyState?document.addEventListener('DOMContentLoaded',()=>{setTimeout(()=>this.checkCustomer(),100)}):setTimeout(()=>this.checkCustomer(),100),this.setupEvents(),this.loadState(),this.checkMobile())}
applyTheme(){const{theme:t}=this.s;this.c.style.setProperty('--rp-primary',t.primaryColor),this.c.style.setProperty('--rp-secondary',t.secondaryColor),this.c.style.setProperty('--rp-text',t.textColor),this.c.style.setProperty('--rp-background',t.backgroundColor)}
checkCustomer(){let e=null;window.RewardsProCustomer&&window.RewardsProCustomer.logged_in?e=window.RewardsProCustomer.id:window.ShopifyAnalytics?.meta?.page?.customerId?e=window.ShopifyAnalytics.meta.page.customerId:window.__st?.cid&&(e=window.__st.cid),e&&''!==e&&'0'!==e&&0!==e?this.fetchData(e.toString()):this.showGuest()}
async fetchData(e){try{const t=window.Shopify?.shop||window.location.hostname,n=await fetch(`${this.s.apiEndpoint}/membership?shop=${t}`,{headers:{'Content-Type':'application/json','X-Shopify-Customer-Id':e}});if(!n.ok)throw Error();const i=await n.json();this.d=i,!1===i.isMember?this.showGuest():this.showMember(i),this.s.autoShow&&!this.seen()&&i.isMember&&(this.show(),this.markSeen())}catch{this.showGuest()}}
showMember(e){this.c.querySelector('.rewardspro-loading-state').style.display='none';const t=this.c.querySelector('.rewardspro-member-content');t.style.display='block';const n=t.querySelector('.rewardspro-points-value');n&&(n.textContent=this.fmt$(e.storeCredit||0));const i=this.m.querySelector('.rewardspro-minimized-points');i&&(i.textContent=this.fmt$(e.storeCredit||0));const r=t.querySelector('.rewardspro-tier-name');r&&e.tier&&(r.textContent=e.tier.name,e.tier.color&&(r.style.color=e.tier.color));const s=t.querySelector('.rewardspro-cashback-rate');s&&e.tier&&(s.textContent=`(${e.tier.cashbackPercent}% cashback)`),e.tierProgress?this.updateProgress(e.tierProgress):this.c.querySelector('.rewardspro-progress-container')?.style.display='none';const o=t.querySelector('.rewardspro-total-earned');o&&void 0!==e.totalEarned&&(o.textContent=`Total Earned: ${this.fmt$(e.totalEarned)}`),this.min?(this.w.style.display='none',this.m.style.display='flex'):(this.w.style.display='block',this.m.style.display='none')}
updateProgress(e){const t=this.c.querySelector('.rewardspro-progress-container');if(!t)return;const n=t.querySelector('.rewardspro-progress-text'),i=t.querySelector('.rewardspro-progress-fill');n&&(n.textContent=`${this.fmt$(e.current)} / ${this.fmt$(e.required)} to ${e.nextTierName}`),i&&(i.style.width=`${Math.min(e.percentComplete||0,100)}%`)}
showGuest(){this.c.querySelector('.rewardspro-loading-state').style.display='none',this.c.querySelector('.rewardspro-guest-content').style.display='block';const e=this.m.querySelector('.rewardspro-minimized-text');e&&(e.textContent='Join Rewards');const t=this.m.querySelector('.rewardspro-minimized-points');t&&(t.style.display='none'),this.min?(this.w.style.display='none',this.m.style.display='flex'):(this.w.style.display='block',this.m.style.display='none')}
setupEvents(){const e=this.w.querySelector('.rewardspro-close-btn');e&&e.addEventListener('click',()=>this.minimize()),this.m.addEventListener('click',()=>this.show());const t=this.w.querySelector('.rewardspro-btn-redeem');t&&t.addEventListener('click',()=>this.handleRedeem()),window.addEventListener('resize',()=>this.checkMobile())}
show(){this.min=!1,this.saveState();const e=this.s.animation;'none'!==e&&this.w.classList.add(`rewardspro-animate-${e}-in`),this.w.style.display='block',this.m.style.display='none',setTimeout(()=>{this.w.classList.remove(`rewardspro-animate-${e}-in`)},300),this.emit('opened')}
minimize(){this.min=!0,this.saveState();const e=this.s.animation;'none'!==e&&this.w.classList.add(`rewardspro-animate-${e}-out`),setTimeout(()=>{this.w.style.display='none',this.m.style.display='flex',this.w.classList.remove(`rewardspro-animate-${e}-out`)},'none'!==e?300:0),this.emit('closed')}
handleRedeem(){this.emit('redeem_clicked'),window.location.href='/checkout'}
checkMobile(){!this.s.showOnMobile&&window.innerWidth<=480?this.c.style.display='none':this.c.style.display='block'}
saveState(){localStorage.setItem(`rp_s_${this.id}`,JSON.stringify({min:this.min,t:Date.now()}))}
loadState(){try{const e=localStorage.getItem(`rp_s_${this.id}`);if(e){const t=JSON.parse(e);Date.now()-t.t<864e5*parseInt(this.s.cookieExpiry)&&(this.min=t.min)}}catch{}}
seen(){try{return'1'===localStorage.getItem('rp_seen')}catch{return!1}}
markSeen(){try{localStorage.setItem('rp_seen','1')}catch{}}
fmt$(e){const t=window.Shopify?.currency?.active||'USD';return new Intl.NumberFormat('en-US',{style:'currency',currency:t}).format(e)}
emit(e,t={}){document.dispatchEvent(new CustomEvent(`rewardspro:${e}`,{detail:{blockId:this.id,customerData:this.d,...t}}))}}
document.addEventListener('DOMContentLoaded',function(){setTimeout(()=>{window.RewardsProSettings&&Object.keys(window.RewardsProSettings).forEach(e=>{new W(e,window.RewardsProSettings[e])})},250)}),window.RewardsProWidget=W}();