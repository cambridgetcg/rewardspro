<!-- File: extensions/rewardspro-widget/blocks/rewards-widget.liquid -->
{% comment %} Simple rewards widget that works {% endcomment %}

{% if block.settings.enabled %}
  <div id="rewardspro-widget-{{ block.id }}" 
       class="rewardspro-widget" 
       data-block-id="{{ block.id }}"
       data-position="{{ block.settings.position }}">
    
    {% comment %} Server-side customer detection {% endcomment %}
    {% if customer %}
      {% comment %} Customer is logged in - show member content {% endcomment %}
      <div class="rp-content rp-member">
        <div class="rp-header">
          <span class="rp-title">{{ block.settings.widget_title }}</span>
          <button class="rp-close" aria-label="Close">&times;</button>
        </div>
        
        <div class="rp-body">
          <div class="rp-welcome">
            Welcome back, {{ customer.first_name | default: "Member" }}!
          </div>
          
          <div class="rp-info">
            <div class="rp-balance">
              <span class="rp-label">{{ block.settings.credit_label }}</span>
              <span class="rp-value" data-credit="0">$0.00</span>
            </div>
            
            <div class="rp-tier">
              <span class="rp-label">Tier:</span>
              <span class="rp-tier-name">Loading...</span>
            </div>
          </div>
          
          <div class="rp-actions">
            <a href="{{ block.settings.dashboard_url }}" class="rp-btn rp-btn-primary">
              {{ block.settings.dashboard_text }}
            </a>
          </div>
        </div>
      </div>
      
      {% comment %} Pass customer data to JavaScript {% endcomment %}
      <script>
        window.RewardsProData = window.RewardsProData || {};
        window.RewardsProData['{{ block.id }}'] = {
          customerId: {{ customer.id | json }},
          customerEmail: {{ customer.email | json }},
          customerName: {{ customer.first_name | json }},
          shopDomain: {{ shop.domain | json }},
          apiEndpoint: {{ block.settings.api_endpoint | default: "https://rewardspro.vercel.app/apps/rewardspro/api" | json }},
          blockId: {{ block.id | json }}
        };
      </script>
      
    {% else %}
      {% comment %} Customer is not logged in - show guest content {% endcomment %}
      <div class="rp-content rp-guest">
        <div class="rp-header">
          <span class="rp-title">{{ block.settings.widget_title }}</span>
          <button class="rp-close" aria-label="Close">&times;</button>
        </div>
        
        <div class="rp-body">
          <p class="rp-message">{{ block.settings.guest_message }}</p>
          
          <div class="rp-actions">
            <a href="{{ routes.account_register_url }}" class="rp-btn rp-btn-primary">
              {{ block.settings.join_text }}
            </a>
            <a href="{{ routes.account_login_url }}" class="rp-btn rp-btn-secondary">
              Sign In
            </a>
          </div>
        </div>
      </div>
    {% endif %}
    
    {% comment %} Minimized button {% endcomment %}
    <button class="rp-minimized" aria-label="Open rewards" style="display: none;">
      <span class="rp-icon">üéÅ</span>
      <span class="rp-text">Rewards</span>
      {% if customer %}
        <span class="rp-mini-value">$0</span>
      {% endif %}
    </button>
  </div>
{% endif %}

{% schema %}
{
  "name": "Rewards Widget",
  "target": "body",
  "stylesheet": "rewards-widget.css",
  "javascript": "rewards-widget.js",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable Widget",
      "default": true
    },
    {
      "type": "text",
      "id": "widget_title",
      "label": "Widget Title",
      "default": "Your Rewards"
    },
    {
      "type": "text",
      "id": "credit_label",
      "label": "Credit Label",
      "default": "Store Credit:"
    },
    {
      "type": "textarea",
      "id": "guest_message",
      "label": "Guest Message",
      "default": "Join our rewards program and earn cashback on every purchase!"
    },
    {
      "type": "text",
      "id": "join_text",
      "label": "Join Button Text",
      "default": "Join Now"
    },
    {
      "type": "text",
      "id": "dashboard_text",
      "label": "Dashboard Button Text",
      "default": "View Dashboard"
    },
    {
      "type": "text",
      "id": "dashboard_url",
      "label": "Dashboard URL",
      "default": "/pages/rewards"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        {"value": "bottom-right", "label": "Bottom Right"},
        {"value": "bottom-left", "label": "Bottom Left"},
        {"value": "top-right", "label": "Top Right"},
        {"value": "top-left", "label": "Top Left"}
      ],
      "default": "bottom-right"
    },
    {
      "type": "text",
      "id": "api_endpoint",
      "label": "API Endpoint",
      "default": "https://rewardspro.vercel.app/apps/rewardspro/api",
      "info": "Your Vercel app URL"
    }
  ]
}
{% endschema %}